// --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCjEnUBeg91At1NpkjVXg8gyfEF6Pf24J0",
        authDomain: "orbitalarena.firebaseapp.com",
        databaseURL: "https://orbitalarena-default-rtdb.firebaseio.com", 
        projectId: "orbitalarena",
        storageBucket: "orbitalarena.firebasestorage.app",
        messagingSenderId: "265516321261",
        appId: "1:265516321261:web:a964edf2ba882ceff27fe4"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. GAME STATE ---
    const ROWS = 12, COLS = 16, CELL = 70;
    let board = [], turn = 'w', myId, myName, currentGameId = null, myColor = null;
    let selected = null, validMoves = [];
    let camX = 50, camY = -150, isPanning = false, lastMouse = {x:0, y:0};
    const PIECES = {'wK':'♔','wQ':'♕','wR':'♖','wB':'♗','wN':'♘','wP':'♙','bK':'♚','bQ':'♛','bR':'♜','bB':'♝','bN':'♞','bP':'♟'};

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Initialize board as empty so it renders even without a game
    board = Array(ROWS).fill().map(() => Array(COLS).fill(""));

    // --- 3. ARENA LOGIC ---
    function joinArena() {
        myName = document.getElementById('username-input').value || "User" + Math.floor(Math.random()*99);
        myId = "id_" + Math.random().toString(36).substr(2, 5);
        document.getElementById('login-overlay').style.display = 'none';

        // Register User
        const myRef = db.ref('players/' + myId);
        myRef.set({ name: myName, status: 'available' });
        myRef.onDisconnect().remove();

        // LIVE LOBBY LISTENER
        db.ref('players').on('value', snap => {
            const container = document.getElementById('players-container');
            container.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                if(child.key === myId) return;
                count++;
                const p = child.val();
                const div = document.createElement('div');
                div.className = 'player-card';
                div.innerHTML = `<span><span class="status-dot"></span>${p.name}</span> 
                                 <button class="btn" onclick="challenge('${child.key}')">FIGHT</button>`;
                container.appendChild(div);
            });
            if(count === 0) container.innerHTML = "Waiting for others to join...";
        });

        // CHALLENGE LISTENER
        db.ref('challenges/' + myId).on('value', snap => {
            const c = snap.val();
            if(c) {
                if(confirm(c.fromName + " has challenged you! Accept?")) {
                    db.ref('challenges/' + myId).remove();
                    initGame(c.gameId, 'b', c.fromName);
                }
            }
        });

        requestAnimationFrame(render); // Start drawing loop immediately
    }

    function challenge(targetId) {
        const gid = "g_" + Date.now();
        db.ref('challenges/' + targetId).set({fromName: myName, gameId: gid});
        initGame(gid, 'w', "Opponent");
    }

    function initGame(gid, col, opp) {
        currentGameId = gid; myColor = col;
        document.getElementById('game-info').style.display = 'block';
        document.getElementById('opp-name').innerText = "VS " + opp;

        if(col === 'w') {
            const newBoard = Array(ROWS).fill().map(() => Array(COLS).fill(""));
            ["R","N","B","Q","K","B","N","R"].forEach((p, i) => {
                newBoard[2][4+i] = "b"+p; newBoard[3][4+i] = "bP";
                newBoard[9][4+i] = "w"+p; newBoard[8][4+i] = "wP";
            });
            db.ref('games/'+gid).set({board: newBoard, turn: 'w'});
        }

        db.ref('games/'+gid).on('value', snap => {
            const data = snap.val();
            if(data) { board = data.board; turn = data.turn; updateUI(); }
        });
    }

    // --- 4. RENDER LOOP (ORBITAL GRID) ---
    function render() {
        canvas.width = window.innerWidth - 320;
        canvas.height = window.innerHeight;
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);

        // Draw an infinite-feeling grid using Toroidal Wrap
        for(let r=-2; r<=ROWS+1; r++) {
            for(let c=-2; c<=COLS+2; c++) {
                const rr = (r % ROWS + ROWS) % ROWS;
                const rc = (c % COLS + COLS) % COLS;
                const x = c * CELL + camX, y = r * CELL + camY;
                
                // Checkerboard colors
                ctx.fillStyle = (rr + rc) % 2 === 0 ? "#e8d5b5" : "#8b6b4d";
                ctx.fillRect(x, y, CELL, CELL);
                
                // Highlight Selected
                if(selected && selected.r === rr && selected.c === rc) {
                    ctx.fillStyle = "rgba(212,175,55,0.5)"; ctx.fillRect(x, y, CELL, CELL);
                }

                // Draw Piece
                if(board[rr] && board[rr][rc]) {
                    ctx.fillStyle = board[rr][rc][0] === 'w' ? "#fff" : "#000";
                    ctx.font = "40px Arial"; ctx.textAlign = "center";
                    ctx.fillText(PIECES[board[rr][rc]], x + CELL/2, y + CELL/2 + 14);
                }
            }
        }
        requestAnimationFrame(render);
    }
