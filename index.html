<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Orbital Chess | Arena Pro</title>
    <style>
        :root { --bg: #0d0d0f; --panel: #1a1a1e; --accent: #d4af37; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        #sidebar { 
            width: 300px; background: var(--panel); display: flex; flex-direction: column; 
            padding: 15px; border-right: 2px solid #2d2d35; box-shadow: 5px 0 25px rgba(0,0,0,0.5); 
        }
        
        /* Lobby & Player List */
        .header h1 { font-size: 0.9rem; letter-spacing: 3px; color: var(--accent); text-align: center; margin-bottom: 15px; }
        #players-container { height: 150px; overflow-y: auto; background: #111; border-radius: 8px; padding: 10px; border: 1px solid #333; }
        .player-card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #4ade80; display: inline-block; margin-right: 5px; }

        /* Chat System */
        #chat-box { flex-grow: 1; display: flex; flex-direction: column; margin-top: 20px; background: #000; border-radius: 8px; border: 1px solid #333; overflow: hidden; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; color: #ccc; }
        .msg { margin-bottom: 5px; }
        .msg-name { color: var(--accent); font-weight: bold; }
        #chat-input-area { display: flex; border-top: 1px solid #333; }
        #chat-input { background: transparent; border: none; color: white; padding: 10px; flex-grow: 1; font-size: 0.8rem; outline: none; }

        /* Match Info */
        #game-info { background: #25252b; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 10px; display: none; border-left: 4px solid var(--accent); }

        canvas { flex-grow: 1; cursor: grab; background: #000; }
        .btn { background: var(--accent); color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.7rem; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="text-align:center; background:#1a1a1e; padding:40px; border-radius:15px; border:1px solid var(--accent);">
            <h1 style="color:var(--accent); letter-spacing:5px;">VANGUARD ARENA</h1>
            <input type="text" id="username-input" placeholder="Enter Nickname" style="padding:12px; border-radius:5px; border:none; width:220px; background:#25252b; color:white;"><br><br>
            <button class="btn" style="padding:12px 40px; font-size:1rem;" onclick="joinArena()">ENTER LOBBY</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="header"><h1>ARENA LOBBY</h1></div>
        
        <div id="game-info">
            <div id="opp-name">VS ---</div>
            <div id="turn-display">YOUR TURN</div>
        </div>

        <div id="players-container"></div>

        <div id="chat-box">
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Press Enter to Chat...">
            </div>
        </div>
        
        <button class="btn" style="margin-top:10px; background:none; border:1px solid #444; color:#666;" onclick="location.reload()">QUIT ARENA</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- 1. CONFIGURATION (REPLACE WITH YOUR KEYS) ---
    const firebaseConfig = {
       apiKey: "AIzaSyCjEnUBeg91At1NpkjVXg8gyfEF6Pf24J0",
  authDomain: "orbitalarena.firebaseapp.com",
  projectId: "orbitalarena",
  storageBucket: "orbitalarena.firebasestorage.app",
  messagingSenderId: "265516321261",
  appId: "1:265516321261:web:a964edf2ba882ceff27fe4",
  measurementId: "G-X1Y7394GZQ"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. GLOBAL STATE ---
    const ROWS = 12, COLS = 16, CELL = 75;
    let board = [], turn = 'w', myId, myName, currentGameId = null, myColor = null;
    let camX = 100, camY = -180, isPanning = false, lastMouse = {x:0, y:0};

    // --- 3. ARENA & CHAT LOGIC ---
    function joinArena() {
        myName = document.getElementById('username-input').value || "Guest" + Math.floor(Math.random()*1000);
        myId = "user_" + Math.random().toString(36).substr(2, 9);
        document.getElementById('login-overlay').style.display = 'none';

        const myRef = db.ref('players/' + myId);
        myRef.set({ name: myName, status: 'available' });
        myRef.onDisconnect().remove();

        setupLobbyListeners();
        setupChat();
    }

    function setupChat() {
        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim() !== "") {
                db.ref('lobbyChat').push({ name: myName, text: chatInput.value });
                chatInput.value = "";
            }
        });

        db.ref('lobbyChat').limitToLast(20).on('child_added', (snap) => {
            const data = snap.val();
            const msgEl = document.createElement('div');
            msgEl.className = 'msg';
            msgEl.innerHTML = `<span class="msg-name">${data.name}:</span> ${data.text}`;
            const container = document.getElementById('chat-messages');
            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;
        });
    }

    function setupLobbyListeners() {
        db.ref('players').on('value', (snap) => {
            const container = document.getElementById('players-container');
            container.innerHTML = "";
            snap.forEach((child) => {
                if(child.key === myId) return;
                const p = child.val();
                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `<span><span class="status-dot"></span>${p.name}</span>
                                 <button class="btn" onclick="sendChallenge('${child.key}','${p.name}')">FIGHT</button>`;
                container.appendChild(card);
            });
        });

        db.ref('challenges/' + myId).on('value', (snap) => {
            const data = snap.val();
            if(data) {
                if(confirm(`${data.fromName} challenges you! Accept?`)) {
                    db.ref('challenges/' + myId).remove();
                    initGame(data.gameId, 'b', data.fromName);
                }
            }
        });
    }

    function sendChallenge(targetId, targetName) {
        const gId = "g_" + [myId, targetId].sort().join("");
        db.ref('challenges/' + targetId).set({ fromId: myId, fromName: myName, gameId: gId });
        initGame(gId, 'w', targetName);
    }

    // --- 4. GAME SYNC ---
    function initGame(gameId, color, oppName) {
        currentGameId = gameId;
        myColor = color;
        document.getElementById('game-info').style.display = 'block';
        document.getElementById('opp-name').innerText = "VS " + oppName;
        
        // Initial setup only for challenger
        if(color === 'w') {
            board = Array(ROWS).fill().map(() => Array(COLS).fill(""));
            const layout = ["R", "N", "B", "Q", "K", "B", "N", "R"];
            layout.forEach((p, i) => {
                board[2][4+i] = "b"+p; board[3][4+i] = "bP";
                board[9][4+i] = "w"+p; board[8][4+i] = "wP";
            });
            syncBoard();
        }

        db.ref('games/' + gameId).on('value', (snap) => {
            const data = snap.val();
            if(data) {
                board = data.board;
                turn = data.turn;
                render();
                updateMatchUI();
            }
        });
    }

    function syncBoard() {
        db.ref('games/' + currentGameId).set({ board: board, turn: turn });
    }

    function updateMatchUI() {
        const el = document.getElementById('turn-display');
        el.innerText = (turn === myColor) ? "YOUR MOVE" : "OPPONENT'S MOVE";
        el.style.color = (turn === myColor) ? "var(--accent)" : "#555";
    }

    // ... (Add your standard render(), getMoves(), and canvas mousedown listeners here)
    // IMPORTANT: In mousedown, add: if(turn !== myColor) return;
</script>
</body>
</html>
