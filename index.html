<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>VANGUARD: ORBITAL ARENA - TACTICAL UPDATE</title>
    <style>
        :root { --bg: #020204; --panel: #0a0a0f; --accent: #d4af37; --text: #d2d2dc; --danger: #ff3232; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { 
            width: 320px; background: var(--panel); padding: 25px; 
            border-right: 1px solid #2a2a35; display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 20;
        }
        .header h1 { font-size: .8rem; letter-spacing: 6px; color: var(--accent); text-align: center; margin-bottom: 20px; }
        
        .timer-box { background: #11111d; padding: 15px; border-radius: 4px; border: 1px solid #d4af3733; margin-bottom: 15px; }
        .fuel-bar { height: 4px; background: #1a1a25; border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .fuel-fill { height: 100%; width: 100%; transition: width 0.1s linear; }

        #turn-prompt { 
            font-weight: bold; color: #fff; background: #1a1a2d; padding: 10px; 
            text-align: center; border: 1px solid var(--accent); margin-bottom: 10px;
            animation: pulse 2s infinite; display: none;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        #move-log { flex-grow: 1; background: #050508; border: 1px solid #1a1a25; padding: 12px; font-family: 'Consolas', monospace; font-size: 0.7rem; overflow-y: auto; color: #666; }

        /* Overlay */
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(2,2,4,0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; text-align: center; }
        .btn { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 12px 30px; margin: 10px; cursor: pointer; font-size: 0.9rem; letter-spacing: 3px; transition: 0.3s; }
        .btn:hover { background: var(--accent); color: #000; }
        #instr { max-width: 500px; font-size: 0.8rem; margin-bottom: 30px; line-height: 1.6; color: #888; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="letter-spacing: 12px; color: var(--accent); margin-bottom: 10px;">VANGUARD V4</h1>
    <div id="lang-btns">
        <button class="btn" onclick="setLang('en')">ENGLISH</button>
        <button class="btn" onclick="setLang('de')">DEUTSCH</button>
    </div>
    <div id="instr">Select a language to view briefing. / Sprache wählen für Briefing.</div>
    <div id="side-selection" style="display:none;">
        <button class="btn" onclick="startGame('w')">WHITE (BOTTOM)</button>
        <button class="btn" onclick="startGame('b')">BLACK (BOTTOM)</button>
    </div>
</div>

<div id="sidebar">
    <div class="header"><h1>TACTICAL HUB</h1></div>
    <div id="turn-prompt">YOUR TURN / DU BIST DRAN</div>
    <div class="timer-box">
        <div style="display:flex; justify-content: space-between; font-size: 0.65rem;"><span>WHITE FUEL</span> <span id="tw-val">60.0s</span></div>
        <div class="fuel-bar"><div id="bw-fill" class="fuel-fill" style="background: var(--accent);"></div></div>
        <div style="display:flex; justify-content: space-between; font-size: 0.65rem; margin-top: 12px;"><span>BLACK FUEL</span> <span id="tb-val">60.0s</span></div>
        <div class="fuel-bar"><div id="bb-fill" class="fuel-fill" style="background: #7a7a9a;"></div></div>
    </div>
    <div id="move-log"></div>
</div>

<div id="canvas-container"><canvas id="gameCanvas"></canvas></div>

<script>
const ROWS = 8, COLS = 16, CELL = 80;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let board, turn = 'w', playerColor = 'w', selected = null, gameActive = false;
let fuel = { w: 60, b: 60 };
let cam = { x: 50, y: 50 }, isPanning = false, lastTick = 0;

const PIECES = { wK:'♔', wQ:'♕', wR:'♖', wB:'♗', wN:'♘', wP:'♙', bK:'♚', bQ:'♛', bR:'♜', bB:'♝', bN:'♞', bP:'♟' };
const VALS = { 'P': 10, 'N': 32, 'B': 33, 'R': 50, 'Q': 90, 'K': 1000 };

const TEXTS = {
    en: "BRIEFING: Toroidal space rules apply. Pieces wrap around edges. Your side is at the bottom. Fuel is replenished (+10s) after every move.",
    de: "BRIEFING: Toroidale Raumregeln gelten. Figuren erscheinen auf Gegenseite. Deine Seite ist unten. Treibstoff füllt sich (+10s) nach jedem Zug."
};

function setLang(l) {
    document.getElementById('instr').innerText = TEXTS[l];
    document.getElementById('lang-btns').style.display = 'none';
    document.getElementById('side-selection').style.display = 'block';
}

function startGame(side) {
    playerColor = side;
    document.getElementById('overlay').style.display = 'none';
    gameActive = true;
    initBoard();
    lastTick = Date.now();
    updateHUD();
    if (playerColor === 'b') setTimeout(aiMove, 600);
    requestAnimationFrame(updateTimer);
}

function initBoard() {
    board = Array(ROWS).fill(null).map(() => Array(COLS).fill(''));
    const layout = ['R','N','B','Q','K','B','N','R'];
    // Setup pieces normally
    for (let i = 0; i < 8; i++) {
        let col = i + 4;
        board[0][col] = 'bP'; board[1][col] = 'b' + layout[i]; board[2][col] = 'bP';
        board[7][col] = 'wP'; board[6][col] = 'w' + layout[i]; board[5][col] = 'wP';
    }
}

function getDisplayCoords(r, c) {
    // If player is Black, flip the vertical view so Row 0 (Black's start) is at the bottom
    if (playerColor === 'b') return { dr: (ROWS - 1) - r, dc: c };
    return { dr: r, dc: c };
}

function getActualCoords(dr, dc) {
    if (playerColor === 'b') return { r: (ROWS - 1) - dr, c: dc };
    return { r: dr, c: dc };
}

function executeMove(from, to) {
    const p = board[from.r][from.c];
    // Fuel Reward
    fuel[turn] = Math.min(60, fuel[turn] + 10);
    
    board[to.r][to.c] = p;
    board[from.r][from.c] = '';
    
    const log = document.getElementById('move-log');
    log.innerHTML = `<div>> ${p[1]} ${from.r}:${from.c} -> ${to.r}:${to.c}</div>` + log.innerHTML;

    if (p[1] === 'K' && (to.r !== from.r || to.c !== from.c)) { /* King moved */ }
    
    turn = turn === 'w' ? 'b' : 'w';
    updateHUD();
    if (gameActive && turn !== playerColor) setTimeout(aiMove, 600);
}

function updateHUD() {
    document.getElementById('turn-prompt').style.display = (turn === playerColor) ? 'block' : 'none';
}

// ── RENDER ENGINE ──────────────────────────────────────────
function draw() {
    canvas.width = window.innerWidth - 320; canvas.height = window.innerHeight;
    ctx.fillStyle = '#000'; ctx.fillRect(0,0, canvas.width, canvas.height);
    if (!gameActive && !board) { requestAnimationFrame(draw); return; }

    for (let r = -1; r < ROWS + 1; r++) {
        for (let c = -1; c < COLS + 1; c++) {
            const rr = (r + ROWS) % ROWS, rc = (c + COLS) % COLS;
            const view = getDisplayCoords(rr, rc);
            const x = rc * CELL + cam.x, y = view.dr * CELL + cam.y;
            
            // Draw Square
            const isLight = (rr + rc) % 2 === 0;
            ctx.fillStyle = isLight ? '#b57a44' : '#1a1a1a';
            ctx.globalAlpha = (r < 0 || r >= ROWS) ? 0.2 : 1.0;
            ctx.fillRect(x, y, CELL, CELL);

            // Highlight Selection
            if (selected && selected.r === rr && selected.c === rc) {
                ctx.strokeStyle = var(--accent); ctx.lineWidth = 3; ctx.strokeRect(x+2, y+2, CELL-4, CELL-4);
            }

            if (board[rr][rc]) {
                ctx.fillStyle = board[rr][rc][0] === 'w' ? '#fff' : '#b19cd9';
                ctx.font = '36px serif'; ctx.textAlign = 'center';
                ctx.fillText(PIECES[board[rr][rc]], x + CELL/2, y + CELL/2 + 13);
            }
        }
    }
    requestAnimationFrame(draw);
}

// ── INPUT HANDLING ──────────────────────────────────────────
canvas.onmousedown = e => {
    if (e.button === 2) isPanning = true;
    else if (gameActive && turn === playerColor) {
        const mx = e.offsetX - cam.x, my = e.offsetY - cam.y;
        const vdc = Math.floor(mx/CELL), vdr = Math.floor(my/CELL);
        const { r, c } = getActualCoords((vdr + ROWS) % ROWS, (vdc + COLS) % COLS);
        
        if (selected) {
            // Check if legal (using standard move logic)
            executeMove(selected, {r, c});
            selected = null;
        } else if (board[r][c] && board[r][c][0] === playerColor) {
            selected = {r, c};
        }
    }
};

// ... (Rest of AI and Timer logic from previous working versions) ...
function updateTimer() {
    if (!gameActive) return;
    let now = Date.now(); let delta = (now - lastTick) / 1000; lastTick = now;
    fuel[turn] -= delta;
    if (fuel[turn] <= 0) { alert("OUT OF FUEL"); location.reload(); }
    document.getElementById('tw-val').innerText = fuel.w.toFixed(1) + 's';
    document.getElementById('tb-val').innerText = fuel.b.toFixed(1) + 's';
    document.getElementById('bw-fill').style.width = (fuel.w / 60 * 100) + '%';
    document.getElementById('bb-fill').style.width = (fuel.b / 60 * 100) + '%';
    requestAnimationFrame(updateTimer);
}

window.onmousemove = e => { if (isPanning) { cam.x += e.movementX; cam.y += e.movementY; } };
window.onmouseup = () => isPanning = false;
window.oncontextmenu = e => e.preventDefault();
draw();
</script>
</body>
</html>
